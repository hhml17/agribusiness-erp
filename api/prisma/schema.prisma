// Prisma Schema - Agribusiness ERP
// Multi-tenant architecture with row-level security

// api/prisma/schema.prisma
datasource db {
  provider = "sqlserver"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ==========================================
// CORE MODELS - Multi-Tenant
// ==========================================

model Tenant {
  id        String   @id @default(uuid())
  nombre    String
  ruc       String   @unique
  direccion String?
  telefono  String?
  email     String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations - Commercial
  usuarios    Usuario[]
  productos   Producto[]
  clientes    Cliente[]
  proveedores Proveedor[]
  ventas      Venta[]
  compras     Compra[]

  // Relations - Accounting
  planCuentas  PlanCuentas[]
  centrosCosto CentroCosto[]
  asientos     AsientoContable[]

  // Relations - Ganado
  categoriasGanado  CategoriaGanado[]
  ganado            Ganado[]
  movimientosGanado MovimientoGanado[]

  // Relations - Pagos y Compras
  cuentasBancarias     CuentaBancaria[]
  chequeras            Chequera[]
  ordenesCompra        OrdenCompra[]
  facturasCompra       FacturaCompra[]
  ordenesPago          OrdenPago[]
  retenciones          Retencion[]
  movimientosBancarios MovimientoBancario[]
  extractosBancarios   ExtractoBancario[]

  // Relations - Actores y Empresa
  actores               Actor[]
  actorCuentasContables ActorCuentaContable[]
  estanciasMejoradas    EstanciaMejorada[]
  talonarios            Talonario[]
  facturasEmitidas      FacturaEmitida[]

  @@map("tenants")
}

model Usuario {
  id        String   @id @default(uuid())
  email     String   @unique
  nombre    String
  apellido  String?
  azureAdId String?  @unique // Azure AD Object ID
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant relations
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])
  role     String @default("USER") // ADMIN | USER | VIEWER

  @@index([tenantId])
  @@index([email])
  @@map("usuarios")
}

// Note: SQLite doesn't support enums, using String with validation
// enum Role {
//   ADMIN
//   USER
//   VIEWER
// }

// ==========================================
// INVENTARIO
// ==========================================

model Producto {
  id          String  @id @default(uuid())
  codigo      String
  nombre      String
  descripcion String?
  categoria   String?

  // LEGACY: Mantener por compatibilidad (deprecated)
  unidadMedida String? // DEPRECATED: usar unidadCompra
  precioCompra Float? // DEPRECATED: usar costo en movimientos
  precioVenta  Float? // DEPRECATED: usar precio en movimientos
  stock        Float   @default(0)
  stockMinimo  Float?

  // ==========================================
  // CAMPOS DNIT - Datos Financieros
  // ==========================================
  tasaIva Float @default(10.0) // 10.0, 5.0, 0.0 (Exenta)

  // Cuenta IVA Crédito Fiscal
  cuentaIvaId String?
  cuentaIva   PlanCuentas? @relation("ProductoIVA", fields: [cuentaIvaId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // CAMPOS DNIT - Tipo de Artículo
  // ==========================================
  tipoArticulo String @default("INSUMO") // INSUMO, ACTIVO_FIJO, ANIMAL, GASTO_DIRECTO, SERVICIO

  // ==========================================
  // CAMPOS DNIT - Doble Unidad de Medida
  // ==========================================
  unidadCompra     String // GLOBAL, TON, M3, UNIDAD, KG, L (para facturación/compra)
  unidadControl    String? // L, KG, CABEZA, UNIDAD (para stock/operaciones)
  factorConversion Float? // Factor de conversión: 1 TON = 1000 KG

  // ==========================================
  // CAMPOS DNIT - Control de Inventario
  // ==========================================
  controlaStock   Boolean @default(false)
  metodoValuacion String? // PROMEDIO, FIFO, IDENTIFICADO (para ganado)

  // ==========================================
  // CAMPOS DNIT - Datos para Ganadería
  // ==========================================
  esAnimal      Boolean @default(false)
  especieAnimal String? // BOVINO, EQUINO, OVINO, PORCINO

  // ==========================================
  // CAMPOS DNIT - Datos para Agricultura
  // ==========================================
  esInsumoAgricola  Boolean @default(false)
  categoriaAgricola String? // SEMILLA, FERTILIZANTE, AGROQUIMICO, HERBICIDA

  // ==========================================
  // Estado y Auditoría
  // ==========================================
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String? // Email del usuario que creó
  updatedBy String? // Email del usuario que actualizó

  // Multi-tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Cuentas Contables (requeridas)
  cuentaInventarioId String?
  cuentaInventario   PlanCuentas? @relation("ProductoInventario", fields: [cuentaInventarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  cuentaCostoId String?
  cuentaCosto   PlanCuentas? @relation("ProductoCosto", fields: [cuentaCostoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  cuentaIngresoId String?
  cuentaIngreso   PlanCuentas? @relation("ProductoIngreso", fields: [cuentaIngresoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Relations
  ventaItems            VentaItem[]
  compraItems           CompraItem[]
  itemsOrdenCompra      ItemOrdenCompra[]
  facturasCompraDetalle FacturaCompraDetalle[]

  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@index([tenantId, tipoArticulo])
  @@index([tenantId, categoria])
  @@index([tenantId, esAnimal])
  @@index([tenantId, esInsumoAgricola])
  @@map("productos")
}

// ==========================================
// CLIENTES
// ==========================================

model Cliente {
  id        String   @id @default(uuid())
  codigo    String
  nombre    String
  ruc       String?
  direccion String?
  telefono  String?
  email     String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  ventas Venta[]

  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@map("clientes")
}

// ==========================================
// PROVEEDORES
// ==========================================

model Proveedor {
  id        String   @id @default(uuid())
  codigo    String
  nombre    String
  ruc       String?
  direccion String?
  telefono  String?
  email     String?
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  compras        Compra[]
  ordenesCompra  OrdenCompra[]
  facturasCompra FacturaCompra[]
  ordenesPago    OrdenPago[]

  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@map("proveedores")
}

// ==========================================
// VENTAS
// ==========================================

model Venta {
  id            String   @id @default(uuid())
  numero        String
  fecha         DateTime @default(now())
  clienteId     String?
  cliente       Cliente? @relation(fields: [clienteId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subtotal      Float
  impuesto      Float    @default(0)
  total         Float
  estado        String   @default("PENDIENTE") // PENDIENTE | COMPLETADA | CANCELADA
  observaciones String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Multi-tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  items VentaItem[]

  @@unique([tenantId, numero])
  @@index([tenantId])
  @@index([fecha])
  @@map("ventas")
}

model VentaItem {
  id         String   @id @default(uuid())
  ventaId    String
  venta      Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cantidad   Float
  precioUnit Float
  subtotal   Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([ventaId])
  @@index([productoId])
  @@map("venta_items")
}

// Note: SQLite doesn't support enums, using String with validation
// enum EstadoVenta {
//   PENDIENTE
//   COMPLETADA
//   CANCELADA
// }

// ==========================================
// COMPRAS
// ==========================================

model Compra {
  id            String     @id @default(uuid())
  numero        String
  fecha         DateTime   @default(now())
  proveedorId   String?
  proveedor     Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subtotal      Float
  impuesto      Float      @default(0)
  total         Float
  estado        String     @default("PENDIENTE") // PENDIENTE | RECIBIDA | CANCELADA
  observaciones String?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  // Multi-tenant
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Relations
  items CompraItem[]

  @@unique([tenantId, numero])
  @@index([tenantId])
  @@index([fecha])
  @@map("compras")
}

model CompraItem {
  id         String   @id @default(uuid())
  compraId   String
  compra     Compra   @relation(fields: [compraId], references: [id], onDelete: Cascade)
  productoId String
  producto   Producto @relation(fields: [productoId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cantidad   Float
  precioUnit Float
  subtotal   Float
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([compraId])
  @@index([productoId])
  @@map("compra_items")
}

// ==========================================
// GANADO
// ==========================================

model CategoriaGanado {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  nombre      String
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ganado Ganado[]

  @@unique([tenantId, nombre])
  @@map("categoria_ganado")
}

model Ganado {
  id          String          @id @default(uuid())
  tenantId    String
  tenant      Tenant          @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  categoriaId String
  categoria   CategoriaGanado @relation(fields: [categoriaId], references: [id])

  arete           String?
  nombre          String?
  fechaNacimiento DateTime?
  sexo            String // MACHO | HEMBRA
  peso            Float?
  estado          String    @default("ACTIVO") // ACTIVO | VENDIDO | MUERTO

  // Relations
  movimientos MovimientoGanado[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, arete])
  @@index([tenantId])
  @@index([categoriaId])
  @@map("ganado")
}

model MovimientoGanado {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  ganadoId String
  ganado   Ganado @relation(fields: [ganadoId], references: [id])

  fecha       DateTime
  tipo        String // COMPRA | VENTA | NACIMIENTO | MUERTE | TRASLADO
  descripcion String?
  peso        Float?
  precio      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([ganadoId])
  @@index([fecha])
  @@map("movimiento_ganado")
}

// Note: SQLite doesn't support enums, using String with validation
// enum EstadoCompra {
//   PENDIENTE
//   RECIBIDA
//   CANCELADA
// }

// ==========================================
// CONTABILIDAD - PLAN DE CUENTAS
// ==========================================

model PlanCuentas {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  // Identificación
  codigo      String // 1.1.01.001
  nombre      String
  descripcion String?

  // Clasificación
  tipo       String // ACTIVO, PASIVO, PATRIMONIO, INGRESO, GASTO
  naturaleza String // DEUDORA, ACREEDORA
  nivel      Int // 1, 2, 3, 4

  // Jerarquía
  cuentaPadreId String?
  cuentaPadre   PlanCuentas?  @relation("CuentaHija", fields: [cuentaPadreId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  cuentasHijas  PlanCuentas[] @relation("CuentaHija")

  // Centro de Costo
  centroCostoId String?
  centroCosto   CentroCosto? @relation(fields: [centroCostoId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subCentro     String?

  // Para gastos
  tipoGasto    String? // COSTO, INVERSION
  variabilidad String? // FIJO, VARIABLE

  // Estado
  aceptaMovimiento Boolean  @default(true) // false para cuentas padre
  activo           Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  lineasAsiento         LineaAsiento[]
  cuentasBancarias      CuentaBancaria[]
  actorCuentas          ActorCuentaContable[]  @relation("ActorCuentas")
  productosInventario   Producto[]             @relation("ProductoInventario")
  productosCosto        Producto[]             @relation("ProductoCosto")
  productosIngreso      Producto[]             @relation("ProductoIngreso")
  productosIVA          Producto[]             @relation("ProductoIVA")
  facturasCompraDetalle FacturaCompraDetalle[] @relation("FacturaCompraCuenta")

  @@unique([tenantId, codigo])
  @@index([tenantId, tipo])
  @@index([tenantId, nivel])
  @@map("plan_cuentas")
}

model CentroCosto {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  codigo      String
  nombre      String // Administración, Bovinos, Pastura, etc.
  descripcion String?
  tipo        String? // OPERATIVO, ADMINISTRATIVO, PRODUCCION
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  cuentas               PlanCuentas[]
  lineasAsiento         LineaAsiento[]
  estanciasMejoradas    EstanciaMejorada[]
  itemsOrdenCompra      ItemOrdenCompra[]      @relation("ItemOrdenCompraCentroCosto")
  facturasCompraDetalle FacturaCompraDetalle[] @relation("FacturaCompraCentroCosto")

  @@unique([tenantId, codigo])
  @@map("centros_costo")
}

// ==========================================
// CONTABILIDAD - ASIENTOS CONTABLES
// ==========================================

model AsientoContable {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  numero      Int
  fecha       DateTime
  descripcion String
  tipo        String // DIARIO, AJUSTE, CIERRE, APERTURA
  estado      String // BORRADOR, CONTABILIZADO, ANULADO

  // Referencia
  documentoRef String? // Factura, pago, etc.
  tipoDoc      String? // FACTURA_COMPRA, FACTURA_VENTA, PAGO, COBRO

  // Auditoría
  contabilizadoPor   String?
  fechaContabilizado DateTime?
  anuladoPor         String?
  fechaAnulado       DateTime?
  motivoAnulacion    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lineas        LineaAsiento[]
  ordenPago     OrdenPago?
  facturaCompra FacturaCompra? @relation("FacturaCompraAsiento")

  @@unique([tenantId, numero])
  @@index([tenantId, fecha])
  @@index([tenantId, estado])
  @@map("asientos_contables")
}

model LineaAsiento {
  id        String          @id @default(uuid())
  asientoId String
  asiento   AsientoContable @relation(fields: [asientoId], references: [id], onDelete: Cascade)

  // Cuenta
  cuentaId String
  cuenta   PlanCuentas @relation(fields: [cuentaId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Centro de Costo (opcional)
  centroCostoId String?
  centroCosto   CentroCosto? @relation(fields: [centroCostoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Importes
  debe  Float @default(0)
  haber Float @default(0)

  // Referencia
  descripcion  String?
  documentoRef String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([asientoId])
  @@index([cuentaId])
  @@map("lineas_asiento")
}

// ==========================================
// GESTIÓN DE PAGOS Y COMPRAS
// ==========================================

// CUENTAS BANCARIAS
model CuentaBancaria {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id])

  banco        String // Nombre del banco
  tipoCuenta   String // CUENTA_CORRIENTE, CAJA_AHORRO
  numeroCuenta String
  moneda       String @default("PYG") // PYG, USD
  saldoActual  Float  @default(0)

  // Relación con Plan de Cuentas
  cuentaContableId String?
  cuentaContable   PlanCuentas? @relation(fields: [cuentaContableId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  chequeras   Chequera[]
  movimientos MovimientoBancario[]
  ordenesPago OrdenPago[]
  extractos   ExtractoBancario[]

  @@unique([tenantId, numeroCuenta])
  @@map("cuentas_bancarias")
}

// CHEQUERAS
model Chequera {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  cuentaBancariaId String
  cuentaBancaria   CuentaBancaria @relation(fields: [cuentaBancariaId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  numeroInicial   Int
  numeroFinal     Int
  siguienteNumero Int // Próximo cheque a usar

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  cheques Cheque[]

  @@map("chequeras")
}

// CHEQUES
model Cheque {
  id         String   @id @default(uuid())
  chequeraId String
  chequera   Chequera @relation(fields: [chequeraId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  numero       Int
  monto        Float
  beneficiario String
  fecha        DateTime
  fechaCobro   DateTime? // Para cheques diferidos
  esDiferido   Boolean   @default(false)

  estado String // EMITIDO, COBRADO, ANULADO, REVERSADO

  // Datos de cobro
  fechaEfectivoCobro DateTime?
  numeroTransaccion  String?

  movimientoBancarioId String?             @unique
  movimientoBancario   MovimientoBancario? @relation(fields: [movimientoBancarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("cheques")
}

// ORDENES DE COMPRA
model OrdenCompra {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  numero String
  fecha  DateTime @default(now())

  proveedorId String
  proveedor   Proveedor @relation(fields: [proveedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  descripcion   String
  observaciones String?

  subtotal Float
  iva      Float @default(0)
  total    Float

  // Workflow
  estado          String // BORRADOR, PENDIENTE_APROBACION, APROBADA, RECHAZADA, ANULADA
  solicitadoPor   String? // Usuario que solicita
  aprobadoPor     String? // Usuario que aprueba
  fechaAprobacion DateTime?
  motivoRechazo   String?

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  items    ItemOrdenCompra[]
  facturas FacturaCompra[]

  @@unique([tenantId, numero])
  @@index([tenantId, estado])
  @@map("ordenes_compra")
}

model ItemOrdenCompra {
  id            String      @id @default(uuid())
  ordenCompraId String
  ordenCompra   OrdenCompra @relation(fields: [ordenCompraId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  lineaNumero Int // Número de línea en la orden

  descripcion    String
  cantidad       Float
  unidadMedida   String
  precioUnitario Float
  subtotal       Float

  productoId String?
  producto   Producto? @relation(fields: [productoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // CAMPOS DNIT - Centro de Costo
  // ==========================================
  centroCostoId String // CRÍTICO: vincular cada ítem a su centro de costo
  centroCosto   CentroCosto @relation("ItemOrdenCompraCentroCosto", fields: [centroCostoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // CAMPOS DNIT - IVA
  // ==========================================
  tasaIva  Float // Tasa de IVA del producto en el momento de la orden
  montoIva Float // Monto calculado de IVA
  total    Float // Subtotal + IVA

  // ==========================================
  // CAMPOS DNIT - Para inventario futuro
  // ==========================================
  cantidadControl Float? // Cantidad convertida a unidad de control
  unidadControl   String? // Unidad de control del producto

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([ordenCompraId, lineaNumero])
  @@index([centroCostoId])
  @@map("items_orden_compra")
}

// FACTURAS DE COMPRA
model FacturaCompra {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // NUMERACIÓN DNIT PARAGUAY
  // ==========================================
  timbrado        String // Timbrado SET
  establecimiento String // "001"
  puntoExpedicion String // "002"
  numero          String // "0003456"
  numeroCompleto  String // "001-002-0003456" (generado automáticamente)

  // ==========================================
  // FECHAS
  // ==========================================
  fechaEmision     DateTime
  fechaRecepcion   DateTime
  fechaVencimiento DateTime?

  // ==========================================
  // PROVEEDOR
  // ==========================================
  proveedorId          String
  proveedor            Proveedor @relation(fields: [proveedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  proveedorRuc         String
  proveedorRazonSocial String

  // ==========================================
  // VINCULACIÓN CON OC (opcional)
  // ==========================================
  ordenCompraId String?
  ordenCompra   OrdenCompra? @relation(fields: [ordenCompraId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // TIPO DE FACTURA
  // ==========================================
  tipo String @default("NORMAL") // NORMAL, ANTICIPO, GASTO_NO_DEDUCIBLE, CAJA_CHICA

  // ==========================================
  // TOTALES DNIT (segregados por tasa)
  // ==========================================
  gravado10    Float @default(0) // Base imponible 10%
  iva10        Float @default(0) // IVA 10%
  gravado5     Float @default(0) // Base imponible 5%
  iva5         Float @default(0) // IVA 5%
  exentas      Float @default(0) // Operaciones exentas
  totalFactura Float // Total general

  // ==========================================
  // MONEDA
  // ==========================================
  moneda     String @default("PYG") // PYG, USD
  tipoCambio Float  @default(1)

  // ==========================================
  // ESTADO Y WORKFLOW
  // ==========================================
  estado         String @default("PENDIENTE") // PENDIENTE, VALIDADA, CONTABILIZADA, ANULADA
  saldoPendiente Float // Total - pagos realizados

  // ==========================================
  // CONTABILIZACIÓN
  // ==========================================
  asientoId            String?          @unique
  asiento              AsientoContable? @relation("FacturaCompraAsiento", fields: [asientoId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  fechaContabilizacion DateTime?

  // ==========================================
  // DATOS ADICIONALES
  // ==========================================
  descripcion   String?
  observaciones String?

  // ==========================================
  // AUDITORÍA
  // ==========================================
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String?
  validatedBy String?
  validatedAt DateTime?

  // ==========================================
  // RELATIONS
  // ==========================================
  detalles    FacturaCompraDetalle[]
  ordenesPago OrdenPago[]

  @@unique([tenantId, timbrado, numeroCompleto])
  @@index([tenantId, estado])
  @@index([proveedorId])
  @@index([fechaEmision])
  @@map("facturas_compra")
}

// DETALLE DE FACTURAS DE COMPRA (NUEVO MODELO DNIT)
model FacturaCompraDetalle {
  id        String        @id @default(uuid())
  facturaId String
  factura   FacturaCompra @relation(fields: [facturaId], references: [id], onDelete: Cascade)

  lineaNumero Int // Número de línea en la factura

  // ==========================================
  // ARTÍCULO/PRODUCTO
  // ==========================================
  articuloId  String?
  articulo    Producto? @relation(fields: [articuloId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  descripcion String

  // ==========================================
  // CANTIDADES (en unidad de compra)
  // ==========================================
  cantidad     Float
  unidadMedida String

  // ==========================================
  // PRECIOS (en unidad de compra)
  // ==========================================
  precioUnitario Float
  subtotal       Float

  // ==========================================
  // IVA DNIT
  // ==========================================
  tasaIva  Float // 10.0, 5.0, 0.0
  montoIva Float
  total    Float

  // ==========================================
  // CENTRO DE COSTO (CRÍTICO)
  // ==========================================
  centroCostoId String
  centroCosto   CentroCosto @relation("FacturaCompraCentroCosto", fields: [centroCostoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // CUENTA CONTABLE
  // ==========================================
  cuentaContableId String
  cuentaContable   PlanCuentas @relation("FacturaCompraCuenta", fields: [cuentaContableId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // ==========================================
  // RELACIÓN CON ORDEN DE COMPRA
  // ==========================================
  ordenCompraDetalleId String?

  // ==========================================
  // CANTIDADES DE CONTROL (para inventario futuro)
  // ==========================================
  cantidadControl  Float?
  unidadControl    String?
  pendienteIngreso Boolean @default(true) // Para controlar ingreso a stock

  // ==========================================
  // AUDITORÍA
  // ==========================================
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([facturaId, lineaNumero])
  @@index([articuloId])
  @@index([centroCostoId])
  @@index([cuentaContableId])
  @@map("facturas_compra_detalle")
}

// ORDENES DE PAGO
model OrdenPago {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  numero String
  fecha  DateTime @default(now())

  // Proveedor/Beneficiario
  proveedorId  String?
  proveedor    Proveedor? @relation(fields: [proveedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  beneficiario String // Nombre del beneficiario

  // Facturas asociadas
  facturaCompraId String?
  facturaCompra   FacturaCompra? @relation(fields: [facturaCompraId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Método de pago
  metodoPago String // EFECTIVO, TRANSFERENCIA, CHEQUE, CHEQUE_DIFERIDO

  // Cuenta bancaria (si aplica)
  cuentaBancariaId String?
  cuentaBancaria   CuentaBancaria? @relation(fields: [cuentaBancariaId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Importes
  montoTotal Float
  montoNeto  Float // Monto después de retenciones

  // Retenciones
  retencionIVA Float @default(0)
  retencionIRE Float @default(0)

  // Workflow
  estado          String // BORRADOR, PENDIENTE_APROBACION, APROBADA, RECHAZADA, PAGADA, ANULADA
  solicitadoPor   String?
  aprobadoPor     String?
  fechaAprobacion DateTime?
  fechaPago       DateTime?
  motivoRechazo   String?

  // Referencia contable
  asientoContableId String?          @unique
  asientoContable   AsientoContable? @relation(fields: [asientoContableId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  descripcion   String?
  observaciones String?

  // Auditoría
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  movimientos MovimientoBancario[]
  retenciones Retencion[]

  @@unique([tenantId, numero])
  @@index([tenantId, estado])
  @@index([proveedorId])
  @@map("ordenes_pago")
}

// RETENCIONES (IVA, IRE)
model Retencion {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  ordenPagoId String
  ordenPago   OrdenPago @relation(fields: [ordenPagoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  tipo              String // IVA, IRE, IRP, OTRO
  numeroComprobante String? // Número del comprobante de retención
  monto             Float
  porcentaje        Float? // Porcentaje aplicado

  // Datos del comprobante
  fechaEmision    DateTime @default(now())
  rucBeneficiario String?

  observaciones String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId])
  @@index([ordenPagoId])
  @@map("retenciones")
}

// MOVIMIENTOS BANCARIOS
model MovimientoBancario {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  cuentaBancariaId String
  cuentaBancaria   CuentaBancaria @relation(fields: [cuentaBancariaId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Tipo de movimiento
  tipo       String // CHEQUE, TRANSFERENCIA, EFECTIVO, DEPOSITO, NOTA_DEBITO, NOTA_CREDITO
  naturaleza String // EGRESO, INGRESO

  // Datos del movimiento
  fecha            DateTime
  numeroReferencia String? // Número de cheque, transferencia, etc.
  monto            Float
  descripcion      String

  // Orden de pago relacionada
  ordenPagoId String?
  ordenPago   OrdenPago? @relation(fields: [ordenPagoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Conciliación
  estado            String // PENDIENTE, CONCILIADO, REVERSADO
  fechaConciliacion DateTime?
  conciliadoPor     String?

  // Datos del extracto bancario
  extractoBancarioId String?
  extractoBancario   ExtractoBancario? @relation(fields: [extractoBancarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Cheque relacionado
  cheque Cheque?

  observaciones String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenantId, estado])
  @@index([cuentaBancariaId])
  @@map("movimientos_bancarios")
}

// EXTRACTOS BANCARIOS
model ExtractoBancario {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  cuentaBancariaId String
  cuentaBancaria   CuentaBancaria @relation(fields: [cuentaBancariaId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  periodo    String // "2025-01" formato YYYY-MM
  fechaDesde DateTime
  fechaHasta DateTime

  saldoInicial Float
  saldoFinal   Float

  // Archivo adjunto
  archivoUrl String?

  estado String // PENDIENTE, CONCILIADO, PARCIAL

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  movimientos    MovimientoBancario[]
  lineasExtracto LineaExtractoBancario[]

  @@unique([tenantId, cuentaBancariaId, periodo])
  @@map("extractos_bancarios")
}

// LINEAS DEL EXTRACTO BANCARIO
model LineaExtractoBancario {
  id         String           @id @default(uuid())
  extractoId String
  extracto   ExtractoBancario @relation(fields: [extractoId], references: [id], onDelete: Cascade)

  fecha            DateTime
  descripcion      String
  numeroReferencia String?
  debito           Float    @default(0)
  credito          Float    @default(0)
  saldo            Float

  // Conciliación
  conciliado           Boolean @default(false)
  movimientoBancarioId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("lineas_extracto_bancario")
}

// ==========================================
// MÓDULO DE ACTORES (Personas Físicas y Jurídicas)
// ==========================================

// ACTOR - Persona Física o Jurídica que puede ser Cliente, Proveedor o Asociado
model Actor {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Tipo de Persona
  tipoPersona String // FISICA, JURIDICA

  // Identificación (OBLIGATORIOS según requerimientos)
  tipoDocumento   String // RUC, CI, PASAPORTE, OTRO
  numeroDocumento String // Número del documento
  dv              String? // Dígito verificador (para RUC)
  nombre          String // Nombre completo (persona física) o Denominación social (jurídica)
  nombreFantasia  String // Nombre comercial o apodo

  // Datos adicionales persona física
  apellido        String?
  fechaNacimiento DateTime?
  estadoCivil     String? // SOLTERO, CASADO, DIVORCIADO, VIUDO

  // Datos adicionales persona jurídica
  razonSocial        String?
  fechaConstitucion  DateTime?
  representanteLegal String?

  // Contacto
  email        String?
  telefono     String?
  celular      String?
  direccion    String?
  ciudad       String?
  departamento String?
  pais         String  @default("PY")

  // Roles (puede tener múltiples roles simultáneamente)
  esCliente   Boolean @default(false)
  esProveedor Boolean @default(false)
  esAsociado  Boolean @default(false)

  // Estado
  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Auditoría
  createdBy String? // Email del usuario que creó
  updatedBy String? // Email del usuario que actualizó

  // Relations
  cuentasContablesPorRol ActorCuentaContable[]

  @@unique([tenantId, numeroDocumento])
  @@index([tenantId, tipoPersona])
  @@index([tenantId, esCliente])
  @@index([tenantId, esProveedor])
  @@index([tenantId, esAsociado])
  @@map("actores")
}

// ACTOR CUENTA CONTABLE - Configuración contable por rol y moneda
model ActorCuentaContable {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  actorId String
  actor   Actor  @relation(fields: [actorId], references: [id], onDelete: Cascade)

  // Rol al que aplica esta cuenta
  rol String // CLIENTE, PROVEEDOR, ASOCIADO

  // Moneda
  moneda String // USD, PYG

  // Cuenta contable asociada
  cuentaContableId String
  cuentaContable   PlanCuentas @relation("ActorCuentas", fields: [cuentaContableId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Configuración adicional
  descripcion String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([actorId, rol, moneda])
  @@index([tenantId])
  @@index([actorId])
  @@map("actor_cuentas_contables")
}

// ==========================================
// MÓDULO DE EMPRESA - CENTROS DE COSTO MEJORADO
// ==========================================

// ESTANCIA MEJORADA - Extiende el modelo existente
model EstanciaMejorada {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  centroCostoId String
  centroCosto   CentroCosto @relation(fields: [centroCostoId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Datos de estancia (requerimiento del documento)
  codigo      String // Código único
  nombre      String // "Fondo Cría - Estancia Don Federico", "Estancia Vaka Reta"
  descripcion String?

  // Ubicación
  direccion    String?
  ciudad       String?
  departamento String?
  pais         String  @default("PY")

  // Datos técnicos
  superficie     Float? // Hectáreas
  superficieUtil Float? // Hectáreas útiles para pastoreo
  capacidadUA    Float? // Unidades Animales
  tipoPropiedad  String // PROPIA, ALQUILADA, COMPARTIDA

  // Datos de alquiler (si aplica)
  costoAlquiler    Float?
  monedaAlquiler   String? // USD, PYG
  fechaVencimiento DateTime?

  // Responsable
  responsable String?
  telefono    String?
  email       String?

  activo    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@index([centroCostoId])
  @@map("estancias_mejoradas")
}

// ==========================================
// MÓDULO DE EMPRESA - TALONARIOS
// ==========================================

// TALONARIO - Control de timbrados para facturación
model Talonario {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Tipo de comprobante
  tipoComprobante String // FACTURA, NOTA_CREDITO, NOTA_DEBITO, AUTOFACTURA

  // Datos del timbrado (SET Paraguay)
  numeroTimbrado     String
  fechaVigenciaDesde DateTime
  fechaVigenciaHasta DateTime

  // Datos del establecimiento
  establecimiento String // Código de 3 dígitos "001"
  puntoVenta      String // Código de 3 dígitos "001"

  // Rango de numeración
  numeroInicial   Int
  numeroFinal     Int
  siguienteNumero Int // Próximo número a usar

  // Configuración
  descripcion   String?
  observaciones String?

  // Estado
  activo    Boolean  @default(true)
  agotado   Boolean  @default(false) // Se marca cuando siguienteNumero > numeroFinal
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  facturasEmitidas FacturaEmitida[]

  @@unique([tenantId, numeroTimbrado, establecimiento, puntoVenta])
  @@index([tenantId, tipoComprobante])
  @@index([tenantId, activo])
  @@map("talonarios")
}

// FACTURA EMITIDA - Facturas y notas de crédito emitidas por la empresa
model FacturaEmitida {
  id       String @id @default(uuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Talonario utilizado
  talonarioId String
  talonario   Talonario @relation(fields: [talonarioId], references: [id], onDelete: NoAction, onUpdate: NoAction)

  // Número de factura (formato: 001-001-0001234)
  establecimiento String
  puntoVenta      String
  numeroFactura   Int
  numeroCompleto  String // "001-001-0001234" (generado automáticamente)

  // Tipo
  tipoComprobante String // FACTURA, NOTA_CREDITO, NOTA_DEBITO

  // Cliente
  actorId          String?
  nombreCliente    String // Nombre del cliente (puede no estar en actores)
  rucCliente       String?
  direccionCliente String?

  // Fechas
  fecha            DateTime
  fechaVencimiento DateTime?

  // Condición de venta
  condicionVenta String // CONTADO, CREDITO

  // Importes
  subtotal Float
  iva10    Float @default(0)
  iva5     Float @default(0)
  exentas  Float @default(0)
  total    Float

  // Moneda
  moneda String @default("PYG") // PYG, USD

  // Estado
  estado          String // EMITIDA, ANULADA, NOTA_CREDITO_APLICADA
  fechaAnulacion  DateTime?
  motivoAnulacion String?

  // Observaciones
  descripcion   String?
  observaciones String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, numeroCompleto])
  @@index([tenantId, estado])
  @@index([talonarioId])
  @@map("facturas_emitidas")
}
