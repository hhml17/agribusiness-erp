// Prisma Schema - Agribusiness ERP
// Multi-tenant architecture with row-level security

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"  // Use "sqlserver" for production
  url      = env("DATABASE_URL")
}

// ==========================================
// CORE MODELS - Multi-Tenant
// ==========================================

model Tenant {
  id          String   @id @default(uuid())
  nombre      String
  ruc         String   @unique
  direccion   String?
  telefono    String?
  email       String?
  activo      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  usuarios    Usuario[]
  productos   Producto[]
  clientes    Cliente[]
  proveedores Proveedor[]
  ventas      Venta[]
  compras     Compra[]

  @@map("tenants")
}

model Usuario {
  id            String   @id @default(uuid())
  email         String   @unique
  nombre        String
  apellido      String?
  azureAdId     String?  @unique  // Azure AD Object ID
  activo        Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Multi-tenant relations
  tenantId      String
  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  role          String   @default("USER") // ADMIN | USER | VIEWER

  @@map("usuarios")
  @@index([tenantId])
  @@index([email])
}

// Note: SQLite doesn't support enums, using String with validation
// enum Role {
//   ADMIN
//   USER
//   VIEWER
// }

// ==========================================
// INVENTARIO
// ==========================================

model Producto {
  id             String   @id @default(uuid())
  codigo         String
  nombre         String
  descripcion    String?
  categoria      String?
  unidadMedida   String   // kg, litros, unidades, etc.
  precioCompra   Float
  precioVenta    Float
  stock          Float    @default(0)
  stockMinimo    Float?
  activo         Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Multi-tenant
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id])

  // Relations
  ventaItems     VentaItem[]
  compraItems    CompraItem[]

  @@map("productos")
  @@unique([tenantId, codigo])
  @@index([tenantId])
  @@index([categoria])
}

// ==========================================
// CLIENTES
// ==========================================

model Cliente {
  id           String   @id @default(uuid())
  codigo       String
  nombre       String
  ruc          String?
  direccion    String?
  telefono     String?
  email        String?
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenant
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  // Relations
  ventas       Venta[]

  @@map("clientes")
  @@unique([tenantId, codigo])
  @@index([tenantId])
}

// ==========================================
// PROVEEDORES
// ==========================================

model Proveedor {
  id           String   @id @default(uuid())
  codigo       String
  nombre       String
  ruc          String?
  direccion    String?
  telefono     String?
  email        String?
  activo       Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Multi-tenant
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id])

  // Relations
  compras      Compra[]

  @@map("proveedores")
  @@unique([tenantId, codigo])
  @@index([tenantId])
}

// ==========================================
// VENTAS
// ==========================================

model Venta {
  id             String      @id @default(uuid())
  numero         String
  fecha          DateTime    @default(now())
  clienteId      String?
  cliente        Cliente?    @relation(fields: [clienteId], references: [id])
  subtotal       Float
  impuesto       Float       @default(0)
  total          Float
  estado         String      @default("PENDIENTE") // PENDIENTE | COMPLETADA | CANCELADA
  observaciones  String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Multi-tenant
  tenantId       String
  tenant         Tenant      @relation(fields: [tenantId], references: [id])

  // Relations
  items          VentaItem[]

  @@map("ventas")
  @@unique([tenantId, numero])
  @@index([tenantId])
  @@index([fecha])
}

model VentaItem {
  id          String   @id @default(uuid())
  ventaId     String
  venta       Venta    @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  productoId  String
  producto    Producto @relation(fields: [productoId], references: [id])
  cantidad    Float
  precioUnit  Float
  subtotal    Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("venta_items")
  @@index([ventaId])
  @@index([productoId])
}

// Note: SQLite doesn't support enums, using String with validation
// enum EstadoVenta {
//   PENDIENTE
//   COMPLETADA
//   CANCELADA
// }

// ==========================================
// COMPRAS
// ==========================================

model Compra {
  id             String       @id @default(uuid())
  numero         String
  fecha          DateTime     @default(now())
  proveedorId    String?
  proveedor      Proveedor?   @relation(fields: [proveedorId], references: [id])
  subtotal       Float
  impuesto       Float        @default(0)
  total          Float
  estado         String       @default("PENDIENTE") // PENDIENTE | RECIBIDA | CANCELADA
  observaciones  String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  // Multi-tenant
  tenantId       String
  tenant         Tenant       @relation(fields: [tenantId], references: [id])

  // Relations
  items          CompraItem[]

  @@map("compras")
  @@unique([tenantId, numero])
  @@index([tenantId])
  @@index([fecha])
}

model CompraItem {
  id          String   @id @default(uuid())
  compraId    String
  compra      Compra   @relation(fields: [compraId], references: [id], onDelete: Cascade)
  productoId  String
  producto    Producto @relation(fields: [productoId], references: [id])
  cantidad    Float
  precioUnit  Float
  subtotal    Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("compra_items")
  @@index([compraId])
  @@index([productoId])
}

// Note: SQLite doesn't support enums, using String with validation
// enum EstadoCompra {
//   PENDIENTE
//   RECIBIDA
//   CANCELADA
// }
