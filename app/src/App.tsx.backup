import { MsalProvider, AuthenticatedTemplate, UnauthenticatedTemplate } from '@azure/msal-react';
import { BrowserRouter, Routes, Route, Navigate } from 'react-router-dom';
import { PublicClientApplication, EventType } from '@azure/msal-browser';
import { msalConfig } from './config/authConfig';
import Login from './pages/Login';
import Dashboard from './pages/Dashboard';
import { Inventario } from './pages/Inventario';
import DashboardContable from './pages/Contabilidad/DashboardContable';
import PlanCuentas from './pages/Contabilidad/PlanCuentas';
import AsientosContables from './pages/Contabilidad/AsientosContables';
import BalanceGeneral from './pages/Contabilidad/BalanceGeneral';
import EstadoResultados from './pages/Contabilidad/EstadoResultados';
import LibroMayor from './pages/Contabilidad/LibroMayor';
import './App.css';

// Check if dev mode is enabled
const isDevMode = import.meta.env.VITE_DEV_MODE === 'true';

// Initialize MSAL
const msalInstance = new PublicClientApplication(msalConfig);

// Initialize MSAL and handle redirect - CRITICAL for authentication flow
msalInstance.initialize().then(() => {
    // Handle the redirect promise from Azure AD
    msalInstance.handleRedirectPromise()
        .then((response) => {
            if (response) {
                console.log('Authentication successful:', response);
                msalInstance.setActiveAccount(response.account);
            } else {
                // Check if there's an already authenticated account
                const accounts = msalInstance.getAllAccounts();
                if (accounts.length > 0) {
                    msalInstance.setActiveAccount(accounts[0]);
                }
            }
        })
        .catch((error) => {
            console.error('Error handling redirect:', error);
        });
});

// Event callback for login success
msalInstance.addEventCallback((event) => {
    if (event.eventType === EventType.LOGIN_SUCCESS && event.payload) {
        const payload = event.payload as any;
        const account = payload.account;
        msalInstance.setActiveAccount(account);
        console.log('Login success event:', account);
    }
});

function App() {
    return (
        <MsalProvider instance={msalInstance}>
            <BrowserRouter>
                <Routes>
                    {/* Public Routes */}
                    <Route path="/app/login" element={<Login />} />
                    <Route path="/login" element={<Login />} />

                    {/* Protected Routes */}
                    <Route path="/app/dashboard" element={
                        <AuthenticatedTemplate>
                            <Dashboard />
                        </AuthenticatedTemplate>
                    } />
                    <Route path="/dashboard" element={
                        <AuthenticatedTemplate>
                            <Dashboard />
                        </AuthenticatedTemplate>
                    } />

                    {/* Inventario Route - Dev mode allows unauthenticated access */}
                    <Route path="/inventario" element={<Inventario />} />
                    <Route path="/app/inventario" element={<Inventario />} />

                    {/* Contabilidad Routes */}
                    <Route path="/contabilidad" element={
                        <AuthenticatedTemplate>
                            <DashboardContable />
                        </AuthenticatedTemplate>
                    } />
                    <Route path="/contabilidad/plan-cuentas" element={
                        <AuthenticatedTemplate>
                            <PlanCuentas />
                        </AuthenticatedTemplate>
                    } />
                    <Route path="/contabilidad/asientos" element={
                        <AuthenticatedTemplate>
                            <AsientosContables />
                        </AuthenticatedTemplate>
                    } />
                    <Route path="/contabilidad/balance" element={
                        <AuthenticatedTemplate>
                            <BalanceGeneral />
                        </AuthenticatedTemplate>
                    } />
                    <Route path="/contabilidad/estado-resultados" element={
                        <AuthenticatedTemplate>
                            <EstadoResultados />
                        </AuthenticatedTemplate>
                    } />
                    <Route path="/contabilidad/mayor" element={
                        <AuthenticatedTemplate>
                            <LibroMayor />
                        </AuthenticatedTemplate>
                    } />

                    {/* Default routes */}
                    <Route path="/app" element={
                        isDevMode ? (
                            <Navigate to="/dashboard" replace />
                        ) : (
                            <>
                                <AuthenticatedTemplate>
                                    <Navigate to="/dashboard" replace />
                                </AuthenticatedTemplate>
                                <UnauthenticatedTemplate>
                                    <Navigate to="/login" replace />
                                </UnauthenticatedTemplate>
                            </>
                        )
                    } />
                    <Route path="/" element={
                        isDevMode ? (
                            <Navigate to="/dashboard" replace />
                        ) : (
                            <>
                                <AuthenticatedTemplate>
                                    <Navigate to="/dashboard" replace />
                                </AuthenticatedTemplate>
                                <UnauthenticatedTemplate>
                                    <Navigate to="/login" replace />
                                </UnauthenticatedTemplate>
                            </>
                        )
                    } />

                    {/* Redirect unknown routes */}
                    <Route path="*" element={<Navigate to="/" replace />} />
                </Routes>
            </BrowserRouter>
        </MsalProvider>
    );
}

export default App;
